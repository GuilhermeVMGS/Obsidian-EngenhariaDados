
O otimizador de consultas (Query Optimizer) é considerado o cérebro do SQL Server. É ele quem transforma o nosso script em um plano de execução.

1. **O Otimizador - Um Modelo Baseado em Custo:** o SQL Server usa um otimizador. Ele não testa todas as possibilidades fisicamente, ele faz cálculos matemáticos baseados em estatísticas.
* *Estastísticas:* o SQL guarda metadados sobre as tabelas (quantas linhas existem, quais valores são mais comuns). Se as estatísticas estiverem desatualizadas, o otimizador vai entender que o caminho está vazio quando na verdade está engarrafado, e escolherá o caminho errado
* *"Bom o Suficiente":* ele não busca o plano perfeito (levaria horas de processamento), mas sim o plano mais eficiente em menos tempo. Por exemplo, se ele levar 10 segundos para achar um plano que economiza 1 segundo de execução, não valeu a pena.

2. **O Plano de Execução:** o resultado do otimizador é o plano de execução. É uma árvore de operadores que diz exatamente a ordem das operações. É a estratégia de guerra do banco.
![[Pasted image 20260107131751.png]]

3. **Como Ler o Plano (A Técnica do Gargalo):** ao analisar um plano de execução para resolver lentidão, precisamos focar em três coisas:
* *As Setas (Largura):* a espessura da seta entre um ícone e outro representa a quantidade de dados. Se há uma seta muito grossa saindo de um operador e entrando em outro, ali pode estar o gargalo.
* *O Custo Relativo (%):* cada ícone tem uma porcentagem abaixo dele. Se um operador de "Sort" (Ordenação) está marcando 90%, significa que quase todo o esforço do banco está sendo gasto apenas para organizar os dados, e não para achá-los.
* *Warning (Avisos):* as vezes aparece um ponto de exclamação amarelo sobre um ícone. Isso pode indicar a falta de memória ou falta de um índice sugerido.

4. **Plano Estimado vs. Plano Real:**
* *Plano Estimado:* é o que o otimizador acha que vai acontecer com base nas estatísticas.
* *Plano Real:* é o que realmente aconteceu após a execução. A diferença entre os dois é onde ocorrer os problemas de performance (ex: ele achou que viria 1 linhas mas vieram 1 milhão)

**Obs.:** o SQL Server guarda esses planos em uma área da memória chamada **Plan Cache**. Se você rodar a mesma query daqui a 5 minutos, ele não chama o Otimizador de novo, ele simplesmente pega o plano que já está pronto no cache para ganhar tempo.